import{_ as st,x as ce,v as A,w as le,y as at,A as it,C as ct,E as lt}from"./static-yoecXErL.js";import{i as Ne,S as We,t as qe,n as ut,W as dt,c as ft,o as pt}from"./ref-ehjBZcli.js";import{G as yt,H as gt}from"./affine-C_E42r0n.js";Intl.Segmenter===void 0&&st(()=>import("./intl_segmenter_polyfill_rs-e-2OOmGD.js"),__vite__mapDeps([])).then(({Segmenter:e})=>{Object.defineProperty(Intl,"Segmenter",{value:e,configurable:!0,writable:!0})});var ht=Object.defineProperty,mt=Object.getOwnPropertyDescriptor,wt=(e,t,n,r)=>{for(var o=r>1?void 0:r?mt(t,n):t,i=e.length-1,l;i>=0;i--)(l=e[i])&&(o=(r?l(t,n,o):l(o))||o);return r&&o&&ht(t,n,o),o};let ue=class extends We{constructor(){super(...arguments),this.currentContent=null}showContent(e){this.currentContent&&this.currentContent.remove(),this.style.display="block",e.classList.add("blocksuite-overlay"),this.currentContent=e,this.append(e)}hideContent(){this.currentContent&&(this.style.display="none",this.currentContent.remove(),this.currentContent=null)}toggle(e){this.currentContent!==e?this.showContent(e):this.hideContent()}render(){return ce``}};ue.styles=Ne`
    left-side-panel {
      padding-top: 50px;
      width: 300px;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      display: none;
    }
  `;ue=wt([qe("left-side-panel")],ue);var bt=Object.defineProperty,vt=Object.getOwnPropertyDescriptor,Fe=(e,t,n,r)=>{for(var o=r>1?void 0:r?vt(t,n):t,i=e.length-1,l;i>=0;i--)(l=e[i])&&(o=(r?l(t,n,o):l(o))||o);return r&&o&&bt(t,n,o),o};let Q=class extends dt(We){constructor(){super(...arguments),this.createPage=()=>{Et(this.editor.page.workspace)}}connectedCallback(){super.connectedCallback(),this.disposables.add(this.editor.page.workspace.slots.pagesUpdated.on(()=>{this.requestUpdate()}))}render(){const e=this.editor.page.workspace,t=[...e.pages.values()];return ce`
      <div @click="${this.createPage}" class="new-page-button">New Page</div>
      ${ft(t,n=>n.id,n=>{const r=pt({backgroundColor:this.editor.page.id===n.id?"var(--affine-hover-color)":void 0,padding:"4px 4px 4px 8px",borderRadius:"4px",cursor:"pointer",display:"flex",justifyContent:"space-between"}),o=()=>{this.editor.page=n,this.editor.page.resetHistory(),this.requestUpdate()},i=()=>{e.removePage(n.id);const l=Array.from(e.pages.values());this.editor.page=l[0],this.requestUpdate()};return ce`<div class="page-item" @click="${o}" style="${r}">
            ${n.meta.title||"Untitled"}
            <div @click="${i}" class="delete-page-icon">
              ${yt}
            </div>
          </div>`})}
    `}};Q.styles=Ne`
    pages-panel {
      display: flex;
      flex-direction: column;
      width: 100%;
      background-color: var(--affine-background-secondary-color);
      font-family: var(--affine-font-family);
      height: 100%;
      padding: 12px;
      gap: 4px;
    }
    .page-item:hover .delete-page-icon {
      display: flex;
    }
    .delete-page-icon {
      display: none;
      padding: 2px;
      border-radius: 4px;
    }
    .delete-page-icon:hover {
      background-color: var(--affine-hover-color);
    }
    .delete-page-icon svg {
      width: 14px;
      height: 14px;
      color: var(--affine-secondary-color);
      fill: var(--affine-secondary-color);
    }
    .new-page-button {
      margin-bottom: 16px;
      border: 1px solid var(--affine-border-color);
      border-radius: 4px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .new-page-button:hover {
      background-color: var(--affine-hover-color);
    }
  `;Fe([ut({attribute:!1})],Q.prototype,"editor",2);Q=Fe([qe("pages-panel")],Q);function Et(e){const t=e.idGenerator();gt(e,{id:t}).catch(console.error)}function re(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class _t extends Error{constructor(t,n,r,o){super(n),re(this,"name",void 0),re(this,"code",void 0),re(this,"stack",void 0),this.name=t,this.code=r,this.stack=o}}const Ct={},Pt={},ze={},He={},St=[Ct,Pt,ze,He],xe=(e,t)=>{const n=St.indexOf(e);return t.message+=`Error ${n}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#`+n,t},Me={__proto__:null,Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError},de="DOMException:",Dt=(e,t,n,r)=>{try{const o=Ke();if(e.startsWith(de)&&o){const i=e.slice(de.length);return new o(t,i)}else if(e in Me){const i=new Me[e](t);return i.stack=r,i.code=n,i}else return new _t(e,t,n,r)}catch{return new Error(`E${n} ${e}: ${t}
${r}`)}},$e=e=>String(e).replace(/^.+\n.+\n/,""),Ke=()=>{try{return DOMException}catch{}},q=e=>typeof e=="string",ye=e=>typeof e=="boolean",F=e=>typeof e=="function",B=e=>typeof e=="object"&&e!==null,X="Error",_=void 0,kt=e=>Promise.resolve(e),J=Array.isArray,xt=()=>"() => replay()",Y="2.0",Mt=(e,t,n,r)=>{const o={jsonrpc:Y,id:e,method:t,params:n,remoteStack:r};return he(o,"id"),Rt(o,"remoteStack"),o},$t=(e,t)=>{const n={jsonrpc:Y,id:e,result:t};return he(n,"id"),n},ge=(e,t,n,r)=>{e===_&&(e=null),t=Math.floor(t),Number.isNaN(t)&&(t=-1);const o={jsonrpc:Y,id:e,error:{code:t,message:n,data:r}};return he(o.error,"data"),o},Ot=(e,t)=>{const n=Ge({},e,t),r=n.error;return r.code=-32700,r.message="Parse error",n},It=e=>ge(e,-32600,"Invalid Request"),jt=e=>ge(e,-32601,"Method not found"),Ge=(e,t,n)=>{const{id:r}=e,{code:o,message:i,data:l}=n(t,e);return ge(r,o,i,l)},Oe=(e="",t=-1)=>n=>{let r=Ie("",()=>n.message),o=Ie(X,(f=n.constructor)=>F(f)&&f.name);const i=Ke();return i&&n instanceof i&&(o=de+n.name),(q(n)||typeof n=="number"||ye(n)||typeof n=="bigint")&&(o=X,r=String(n)),{code:t,message:r,data:e?{stack:e,type:o}:{type:o}}},G=e=>{if(!B(e)||!("jsonrpc"in e)||e.jsonrpc!==Y)return!1;if("params"in e){const t=e.params;if(!J(t)&&!B(t))return!1}return!0},Ie=(e,t)=>{try{const n=t();return n===_?e:String(n)}catch{return e}},he=(e,t)=>{e[t]===_&&delete e[t]},Rt=(e,t)=>{e[t]||delete e[t]},me="AsyncCall/",Lt=Symbol.for(me+"ignored"),je=Symbol.for(me+"notify"),At=Symbol.for(me+"batch"),Bt=()=>Math.random().toString(36).slice(2),oe=e=>e===void 0?!0:e,Tt=e=>{if(e==="all")return[!0,!0,!0,!0,!0,!0];if(!ye(e)){const{beCalled:t,localError:n,remoteError:r,type:o,requestReplay:i,sendLocalStack:l}=e;return[oe(t),oe(n),oe(r),o!=="basic",i,l]}return e?[!0,!0,!0,!0]:[]},Ut=e=>{if(!ye(e)){const{methodNotFound:t,unknownMessage:n}=e;return[t,n]}return[e,e]};function ln(e,t){let n=!0,r,o,i,l;const f=async()=>{try{r=await e}catch(s){o=s,P("AsyncCall failed to start",s)}finally{n=!1}},y=s=>{if(i=s,Nt(s)&&s.setup(a=>be(a).then(ve),a=>{const u=Ee(a);return G(u)?!0:kt(u).then(G)}),Vt(s)){const a=s;a.on&&a.on(u=>be(u).then(ve).then(d=>d&&a.send(d)))}return s},{serializer:g,key:S="rpc",strict:j=!0,log:C=!0,parameterStructures:T="by-position",preferLocalImplementation:Z=!1,idGenerator:ee=Bt,mapError:R,logger:z,channel:U,thenable:H}=t;e instanceof Promise?f():(r=e,n=!1);const[te,K]=Ut(j),[c,p,b,v,k,E]=Tt(C),{log:h,error:P=h,debug:V=h,groupCollapsed:Ze=h,groupEnd:et=h,warn:tt=h}=z||console,N=new Map,nt=async s=>{if(n)await f();else if(o)return _e(o,"",s);let a="";try{const{params:u,method:d,id:m,remoteStack:x}=s,D=d.startsWith("rpc.")?Symbol.for(d):d,O=r&&r[D];if(!F(O)){if(te)return jt(m);p&&V("Missing method",D,s);return}const M=J(u)?u:[u];a=$e(new Error().stack);const $=new Promise(W=>W(O.apply(r,M)));if(c)if(v){const W=[`${S}.%c${d}%c(${M.map(()=>"%o").join(", ")}%c)
%o %c@${m}`,"color: #d2c057","",...M,"",$,"color: gray; font-style: italic;"];if(k){const ke=()=>{debugger;return O.apply(r,M)};ke.toString=xt,W.push(ke)}x?(Ze(...W),h(x),et()):h(...W)}else h(`${S}.${d}(${[...M].toString()}) @${m}`);const w=await $;return w===Lt?void 0:$t(m,w)}catch(u){return _e(u,a,s)}},rt=async s=>{let a="",u="",d=0,m=X;if("error"in s){const $=s.error;a=$.message,d=$.code;const w=$.data;B(w)&&"stack"in w&&q(w.stack)?u=w.stack:u="<remote stack not available>",B(w)&&"type"in w&&q(w.type)?m=w.type:m=X,b&&(v?P(`${m}: ${a}(${d}) %c@${s.id}
%c${u}`,"color: gray",""):P(`${m}: ${a}(${d}) @${s.id}
${u}`))}const{id:x}=s;if(x===null||x===_||!N.has(x))return;const[D,O,M=""]=N.get(x);N.delete(x),"error"in s?O(Dt(m,a,d,u+`
    Ð°t AsyncCall (rpc) 
`+M)):D(s.result)},be=async s=>{let a,u=_;try{if(a=await Ee(s),G(a))return u=await Pe(a);if(J(a)&&a.every(G)&&a.length!==0)return Promise.all(a.map(Pe));if(K){let d=a.id;return d===_&&(d=null),It(d)}else return _}catch(d){return p&&P(d,a,u),Ot(d,R||Oe(d&&d.stack))}},ve=async s=>{if(s)if(J(s)){const a=s.filter(u=>u&&"id"in u);return a.length===0?void 0:ne(a)}else return ne(s)},ne=g?s=>g.serialization(s):Object,Ee=g?s=>g.deserialization(s):Object;U instanceof Promise?l=U.then(y):y(U);const _e=(s,a,u)=>(B(s)&&"stack"in s&&(s.stack=a.split(`
`).reduce((d,m)=>d.replace(m+`
`,""),""+s.stack)),p&&P(s),Ge(u,s,R||Oe(E?s.stack:_))),Ce=async(s,a=!1)=>{a&&(s=[...s]);const u=await ne(s);return(i||await l).send(u)},ot=(s,a)=>{for(const u of s)if("id"in u){const d=N.get(u.id);d&&d[1](a)}},Pe=async s=>{if("method"in s){const a=nt(s);if("id"in s)return a;try{await a}catch{}return _}return rt(s)},Se=(s,a,u,d=!1)=>new Promise((m,x)=>{let D=_;if(s===At&&(D=a.shift(),s=a.shift()),typeof s=="symbol"){const w=Symbol.keyFor(s)||s.description;if(w)if(w.startsWith("rpc."))s=w;else throw new TypeError("Not start with rpc.")}else if(s.startsWith("rpc."))throw xe(ze,new TypeError);if(Z&&!n&&q(s)){const w=r&&r[s];if(F(w))return m(w(...a))}const O=ee();u=$e(u);const M=T==="by-name"&&a.length===1&&B(a[0])?a[0]:a,$=Mt(d?_:O,s,M,E?u:_);if(D?(D.push($),D.r||(D.r=[()=>Ce(D,!0),w=>ot(D,w)])):Ce($).catch(x),d)return m();N.set(O,[m,x,u])}),De=(s,a)=>{const u={[a]:(...m)=>Se(a,m,new Error().stack)}[a],d={[a]:(...m)=>Se(a,m,new Error().stack,!0)}[a];return u[je]=d[je]=d,q(a)&&Object.defineProperty(L,a,{value:u,configurable:!0}),u},L={__proto__:new Proxy({},{get:De})};return H===!1?L.then=_:H===_&&Object.defineProperty(L,"then",{configurable:!0,get(){tt(xe(He,new TypeError("RPC used as Promise: ")))}}),new Proxy(L,{getPrototypeOf:()=>null,setPrototypeOf:(s,a)=>a===null,getOwnPropertyDescriptor(s,a){return a in L||De(s,a),Object.getOwnPropertyDescriptor(L,a)}})}const Vt=e=>"send"in e&&F(e.send),Nt=e=>"setup"in e&&F(e.setup),Wt=(e,t)=>t.some(n=>e instanceof n);let Re,Le;function qt(){return Re||(Re=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ft(){return Le||(Le=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Je=new WeakMap,fe=new WeakMap,Qe=new WeakMap,se=new WeakMap,we=new WeakMap;function zt(e){const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("success",i),e.removeEventListener("error",l)},i=()=>{n(I(e.result)),o()},l=()=>{r(e.error),o()};e.addEventListener("success",i),e.addEventListener("error",l)});return t.then(n=>{n instanceof IDBCursor&&Je.set(n,e)}).catch(()=>{}),we.set(t,e),t}function Ht(e){if(fe.has(e))return;const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",l),e.removeEventListener("abort",l)},i=()=>{n(),o()},l=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",i),e.addEventListener("error",l),e.addEventListener("abort",l)});fe.set(e,t)}let pe={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return fe.get(e);if(t==="objectStoreNames")return e.objectStoreNames||Qe.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return I(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Kt(e){pe=e(pe)}function Gt(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(ae(this),t,...n);return Qe.set(r,t.sort?t.sort():[t]),I(r)}:Ft().includes(e)?function(...t){return e.apply(ae(this),t),I(Je.get(this))}:function(...t){return I(e.apply(ae(this),t))}}function Jt(e){return typeof e=="function"?Gt(e):(e instanceof IDBTransaction&&Ht(e),Wt(e,qt())?new Proxy(e,pe):e)}function I(e){if(e instanceof IDBRequest)return zt(e);if(se.has(e))return se.get(e);const t=Jt(e);return t!==e&&(se.set(e,t),we.set(t,e)),t}const ae=e=>we.get(e);function Qt(e,t,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){const l=indexedDB.open(e,t),f=I(l);return r&&l.addEventListener("upgradeneeded",y=>{r(I(l.result),y.oldVersion,y.newVersion,I(l.transaction),y)}),n&&l.addEventListener("blocked",y=>n(y.oldVersion,y.newVersion,y)),f.then(y=>{i&&y.addEventListener("close",()=>i()),o&&y.addEventListener("versionchange",g=>o(g.oldVersion,g.newVersion,g))}).catch(()=>{}),f}const Xt=["get","getKey","getAll","getAllKeys","count"],Yt=["put","add","delete","clear"],ie=new Map;function Ae(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(ie.get(t))return ie.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=Yt.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||Xt.includes(n)))return;const i=async function(l,...f){const y=this.transaction(l,o?"readwrite":"readonly");let g=y.store;return r&&(g=g.index(f.shift())),(await Promise.all([g[n](...f),o&&y.done]))[0]};return ie.set(t,i),i}Kt(e=>({...e,get:(t,n,r)=>Ae(t,n)||e.get(t,n,r),has:(t,n)=>!!Ae(t,n)||e.has(t,n)}));function Be(e,t="val does not exist"){if(e==null)throw t instanceof Error?t:new Error(t)}function Xe(e,t){if(e.guid===t)return e;for(const n of e.subdocs){const r=Xe(n,t);if(r)return r}}const Zt=(e,t,n={})=>{let r=!1;const o=new Map,i=new Map,l=new Set;let f=null;const{origin:y="lazy-provider"}=n;let g={type:"idle"},S=0;const j=new Set,C=c=>{c.type==="syncing"?S++:(c.type==="synced"||c.type==="error")&&S--,S<0&&console.error("syncingStatus < 0, this should not happen",n.origin),S===0&&(g=c),c.type!=="synced"&&(g=c),S===0&&(r?g={type:"synced"}:g={type:"idle"}),j.forEach(p=>p())};async function T(c){const p=c.guid;{const v=p.startsWith("space:")?p.slice(6):p,k=`${e.guid}:space:${v}`,E=`space:${v}`,h=await t.queryDocState(k),P=await t.queryDocState(E);let V=!1;h&&h.missing.length!==2&&h.missing[0]!==0&&h.missing[1]!==0&&(A(c,h.missing,y),V=!0),P&&P.missing.length!==2&&P.missing[0]!==0&&P.missing[1]!==0&&(A(c,P.missing,y),V=!0),V&&await t.sendDocUpdate(p,le(c,h?h.state:P?P.state:void 0))}if(!r)return;C({type:"syncing"});const b=await t.queryDocState(p,{stateVector:at(c)}).then(v=>(C({type:"synced"}),v)).catch(v=>{throw C({type:"error",error:v}),v});o.set(p,[]),b&&A(c,b.missing,y),r&&(await t.sendDocUpdate(p,le(c,b?b.state:void 0)),c.emit("sync",[]))}function Z(c){const p=new Set;i.set(c.guid,p);const b=async(k,E)=>{y!==E&&(C({type:"syncing"}),t.sendDocUpdate(c.guid,k).then(()=>{C({type:"synced"})}).catch(h=>{C({type:"error",error:h}),console.error(h)}))},v=k=>{k.loaded.forEach(E=>{R(E).catch(console.error)}),k.removed.forEach(E=>{z(E)})};c.on("update",b),c.on("subdocs",v),p.add(()=>{c.off("update",b),c.off("subdocs",v)})}function ee(){var c;Be(f,"abortController should be defined");const p=(c=t.onDocUpdate)==null?void 0:c.call(t,(b,v)=>{var k;C({type:"syncing"});const E=Xe(e,b);E?(A(E,v,y),o.has(b)&&((k=o.get(b))==null||k.forEach(h=>A(E,h,y)),o.delete(b))):(console.warn("doc not found",b),o.set(b,(o.get(b)??[]).concat(v))),C({type:"synced"})});f.signal.addEventListener("abort",()=>{p?.()})}async function R(c){l.has(c.guid)||(l.add(c.guid),Z(c),await T(c),await Promise.all([...c.subdocs].filter(p=>p.shouldLoad).map(p=>R(p))))}function z(c){l.delete(c.guid);const p=i.get(c.guid);p&&(p.forEach(b=>b()),i.delete(c.guid)),c.subdocs.forEach(z)}function U(){i.forEach(c=>{c.forEach(p=>p())}),i.clear(),l.clear()}function H(){r=!0,f=new AbortController,C({type:"syncing"}),R(e).then(()=>{C({type:"synced"})}).catch(c=>{C({type:"error",error:c}),console.error(c)}),ee()}async function te(){r=!1,U(),Be(f,"abortController should be defined"),f.abort(),f=null}const K=async c=>{await T(c),await Promise.all([...c.subdocs.values()].map(p=>K(p)))};return{sync:async c=>{r=!0;try{c?await T(e):await K(e)}finally{r=!1}},get status(){return g},subscribeStatusChange(c){return j.add(c),()=>{j.delete(c)}},get connected(){return r},passive:!0,connect:H,disconnect:te,datasource:t}},Te=e=>(e.preventDefault(),e.returnValue="Data is not saved. Are you sure you want to leave?"),en=async e=>{window.addEventListener("beforeunload",Te,{capture:!0}),await e,window.removeEventListener("beforeunload",Te,{capture:!0})},tn=1,Ye="affine-local";function nn(e){e.createObjectStore("workspace",{keyPath:"id"}),e.createObjectStore("milestone",{keyPath:"id"})}function Ue(e,t="val does not exist"){if(e==null)throw t instanceof Error?t:new Error(t)}function Ve(e){const t=new lt;return e.forEach(n=>{A(t,n)}),le(t)}let rn=500;const on=({dbName:e=Ye,mergeCount:t})=>{let n=null;const r=async()=>(n===null&&(n=Qt(e,tn,{upgrade:nn})),n);return{queryDocState:async(o,i)=>{var l;try{const f=await(await r()).transaction("workspace","readonly").objectStore("workspace").get(o);if(!f)return!1;const{updates:y}=f,g=Ve(y.map(({update:S})=>S));return{missing:i!=null&&i.stateVector?it(g,i?.stateVector):g,state:ct(g)}}catch(f){if(!((l=f.message)!=null&&l.includes("The database connection is closing.")))throw f;return!1}},sendDocUpdate:async(o,i)=>{var l;try{const f=(await r()).transaction("workspace","readwrite").objectStore("workspace"),{updates:y}=await f.get(o)??{updates:[]};let g=[...y,{timestamp:Date.now(),update:i}];if(t&&g.length>=t){const S=Ve(g.map(({update:j})=>j));g=[{timestamp:Date.now(),update:S}]}await en(f.put({id:o,updates:g}))}catch(f){if(!((l=f.message)!=null&&l.includes("The database connection is closing.")))throw f}},disconnect:()=>{r().then(o=>o.close()).then(()=>{n=null}).catch(console.error)},cleanup:async()=>{await(await r()).clear("workspace")}}},un=(e,t=Ye)=>{const n=on({dbName:t,mergeCount:rn});let r=null;const o={get status(){return Ue(r),r.status},subscribeStatusChange(i){return Ue(r),r.subscribeStatusChange(i)},connect:()=>{o.connected&&o.disconnect(),r=Zt(e,n,{origin:"idb"}),r.connect()},disconnect:()=>{n?.disconnect(),r?.disconnect(),r=null},cleanup:async()=>{await n?.cleanup()},get connected(){return r?.connected||!1},datasource:n};return o};export{ln as A,ue as L,Q as P,un as W};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=index-UxVMN9Je.js.map
